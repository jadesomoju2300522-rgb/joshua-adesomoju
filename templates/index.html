<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Emotion Detection Web App</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <header>
    <h1>Emotion Detection</h1>
    <p class="sub">Detect emotions from a photo upload or live camera capture.</p>
  </header>

  <main>
    <section class="card">
      <h2>Enter your name</h2>
      <input id="nameInput" type="text" placeholder="e.g., Ada Lovelace">
    </section>

    <section class="tabs">
      <button id="cameraTab" class="tab active">Use Camera</button>
      <button id="uploadTab" class="tab">Upload Image</button>
    </section>

    <section id="cameraPane" class="pane show">
      <div class="grid2">
        <div>
          <video id="video" autoplay playsinline></video>
          <canvas id="canvas" class="hidden"></canvas>
          <div class="row">
            <button id="startBtn">Start camera</button>
            <button id="captureBtn" class="primary">Capture & Analyze</button>
          </div>
        </div>
        <div class="resultBox">
          <h3>Result</h3>
          <div id="camResult" class="result">No result yet.</div>
          <img id="preview" class="preview hidden"/>
        </div>
      </div>
    </section>

    <section id="uploadPane" class="pane">
      <form id="uploadForm">
        <input type="file" id="fileInput" name="image" accept="image/*">
        <button type="submit" class="primary">Analyze Upload</button>
      </form>
      <div class="resultBox">
        <h3>Result</h3>
        <div id="uploadResult" class="result">No result yet.</div>
      </div>
    </section>

    <section class="card">
      <h2>Recent Records</h2>
      <table id="recordsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Name</th>
            <th>Mode</th>
            <th>Emotion</th>
            <th>Score</th>
            <th>Image</th>
            <th>Time (UTC)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    <small>© 2025 Emotion Detection Demo • Powered by Flask + <code>fer</code></small>
  </footer>

  <script>
    const cameraTab = document.getElementById('cameraTab');
    const uploadTab = document.getElementById('uploadTab');
    const cameraPane = document.getElementById('cameraPane');
    const uploadPane = document.getElementById('uploadPane');

    cameraTab.addEventListener('click', () => {
      cameraTab.classList.add('active'); uploadTab.classList.remove('active');
      cameraPane.classList.add('show'); uploadPane.classList.remove('show');
    });
    uploadTab.addEventListener('click', () => {
      uploadTab.classList.add('active'); cameraTab.classList.remove('active');
      uploadPane.classList.add('show'); cameraPane.classList.remove('show');
    });

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const camResult = document.getElementById('camResult');
    const preview = document.getElementById('preview');
    const nameInput = document.getElementById('nameInput');

    startBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (e) {
        alert('Could not access camera: ' + e.message);
      }
    });

    captureBtn.addEventListener('click', async () => {
      const name = nameInput.value || "Anonymous";
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h) { alert('Camera not started yet.'); return; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const dataURL = canvas.toDataURL('image/jpeg', 0.92);
      preview.src = dataURL; preview.classList.remove('hidden');

      const res = await fetch('/predict_camera', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name, image_base64: dataURL })
      });
      const out = await res.json();
      if (out.ok) {
        camResult.textContent = `${out.emotion} (${(out.score*100).toFixed(1)}%)`;
        loadRecords();
      } else {
        camResult.textContent = 'Error: ' + out.error;
      }
    });

    const uploadForm = document.getElementById('uploadForm');
    const uploadResult = document.getElementById('uploadResult');

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = nameInput.value || "Anonymous";
      const fd = new FormData(uploadForm);
      fd.append('name', name);
      const res = await fetch('/predict_upload', { method: 'POST', body: fd });
      const out = await res.json();
      if (out.ok) {
        uploadResult.textContent = `${out.emotion} (${(out.score*100).toFixed(1)}%)`;
        loadRecords();
      } else {
        uploadResult.textContent = 'Error: ' + out.error;
      }
    });

    async function loadRecords() {
      const res = await fetch('/records?limit=20');
      const out = await res.json();
      if (!out.ok) return;
      const tbody = document.querySelector('#recordsTable tbody');
      tbody.innerHTML = '';
      out.records.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.name}</td>
          <td>${r.mode}</td>
          <td>${r.emotion}</td>
          <td>${r.score !== null ? (r.score*100).toFixed(1)+'%' : ''}</td>
          <td>${r.image_path ? `<a href='/${r.image_path}' target='_blank'>view</a>` : ''}</td>
          <td><small>${r.created_at}</small></td>
        `;
        tbody.appendChild(tr);
      });
    }

    loadRecords();
  </script>
</body>
</html>